<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/utils/EventListener.js | kleros-api</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A Javascript library that makes it easy to build relayers and other DApps that use the Kleros protocol."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="kleros-api"><meta property="twitter:description" content="A Javascript library that makes it easy to build relayers and other DApps that use the Kleros protocol."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/kleros.js~Kleros.html">Kleros</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#contracts">contracts</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/AbstractContract.js~AbstractContract.html">AbstractContract</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/ContractImplementation.js~ContractImplementation.html">ContractImplementation</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#contracts-abstractions">contracts/abstractions</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/abstractions/Arbitrable.js~ArbitrableContract.html">ArbitrableContract</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/abstractions/Arbitrator.js~Arbitrator.html">Arbitrator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/abstractions/MultipleArbitrable.js~ArbitrableContract.html">ArbitrableContract</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#contracts-implementations-pnk">contracts/implementations/PNK</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/implementations/PNK/MiniMePinakion.js~MiniMePinakion.html">MiniMePinakion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/implementations/PNK/PinakionPOC.js~PinakionPOC.html">PinakionPOC</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/implementations/PNK/TokenFactory.js~TokenFactory.html">TokenFactory</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#contracts-implementations-rng">contracts/implementations/RNG</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/implementations/RNG/BlockHashRNG.js~BlockHashRNG.html">BlockHashRNG</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#contracts-implementations-arbitrable">contracts/implementations/arbitrable</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/implementations/arbitrable/Arbitrable.js~Arbitrable.html">Arbitrable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/implementations/arbitrable/ArbitrablePermissionList.js~ArbitrablePermissionList.html">ArbitrablePermissionList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/implementations/arbitrable/ArbitrableTransaction.js~ArbitrableTransaction.html">ArbitrableTransaction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/implementations/arbitrable/MultipleArbitrableTransaction.js~MultipleArbitrableTransaction.html">MultipleArbitrableTransaction</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#contracts-implementations-arbitrator">contracts/implementations/arbitrator</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/implementations/arbitrator/Kleros.js~Kleros.html">Kleros</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/contracts/implementations/arbitrator/KlerosPOC.js~KlerosPOC.html">KlerosPOC</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#resources">resources</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Auth.js~Auth.html">Auth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Disputes.js~Disputes.html">Disputes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Notifications.js~Notifications.html">Notifications</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/EventListener.js~EventListener.html">EventListener</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/StoreProviderWrapper.js~StoreProviderWrapper.html">StoreProviderWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/Web3Wrapper.js~Web3Wrapper.html">Web3Wrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PromiseQueue">PromiseQueue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-delegateCalls">delegateCalls</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deployContractAsync">deployContractAsync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getContractAddress">getContractAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-httpRequest">httpRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isRequired">isRequired</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/utils/EventListener.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import _ from &apos;lodash&apos;

import PromiseQueue from &apos;../utils/PromiseQueue&apos;
import isRequired from &apos;../utils/isRequired&apos;
import * as errorConstants from &apos;../constants/error&apos;

/**
 * EventListener is used to watch events on the blockchain for a set of contracts.
 * Handlers for specific events can be added. When an event log is found EventListener
 * will fire all handlers registered for the contract.
 */
class EventListener {
  /**
   * Listen for events in contract and handles callbacks with registered event handlers.
   * @param {object[]} _contractImplementations - Contract Implementation instances to fetch event logs for.
   */
  constructor(_contractImplementations = []) {
    this.contractInstances = []
    // map address -&gt; { event: [handlers], ... }
    this.contractEventHandlerMap = {}
    // map address -&gt; watcher instance
    this.watcherInstances = {}
    // event handler queue
    this.eventHandlerQueue = new PromiseQueue()
    // initialize class variables for new contract instances
    _contractImplementations.forEach(instance =&gt; {
      this.addContractImplementation(instance)
    })
  }

  /**
   * Fetch all logs from contractInstance in a block range.
   * @param {object} contractImplementationInstance - Contract Implementation instance.
   * @param {number} firstBlock - Lower bound of search range.
   * @param {number} lastBlock - Upper bound of search range.
   * @returns {Promise} All events in block range.
   */
  static getAllEventLogs = async (
    contractImplementationInstance = isRequired(
      &apos;contractImplementationInstance&apos;
    ),
    firstBlock = 0,
    lastBlock = &apos;latest&apos;
  ) =&gt;
    Promise.all(
      (await contractImplementationInstance.loadContract())
        .allEvents({
          fromBlock: firstBlock,
          toBlock: lastBlock
        })
        .get((error, result) =&gt; {
          if (error)
            throw new Error(errorConstants.ERROR_FETCHING_EVENTS(error))

          return result
        })
    )

  /**
   * Fetch logs from contractInstance for a specific event in a block range.
   * @param {object} contractImplementationInstance - contract Implementation instance.
   * @param {string} eventName - Name of the event.
   * @param {number} firstBlock - Lower bound of search range.
   * @param {number} lastBlock - Upper bound of search range.
   * @param {object} filters - Extra filters
   * @returns {Promise} All events in block range.
   */
  static getEventLogs = async (
    contractImplementationInstance = isRequired(
      &apos;contractImplementationInstance&apos;
    ),
    eventName = isRequired(&apos;eventName&apos;),
    firstBlock = 0,
    lastBlock = &apos;latest&apos;,
    filters = {}
  ) =&gt; {
    await contractImplementationInstance.loadContract()
    return new Promise((resolve, reject) =&gt; {
      contractImplementationInstance.contractInstance[eventName](filters, {
        fromBlock: firstBlock,
        toBlock: lastBlock
      }).get((error, result) =&gt; {
        if (error) reject(errorConstants.ERROR_FETCHING_EVENTS(error))

        resolve(result)
      })
    })
  }

  /**
   * Add a contract instance to watch for new event logs.
   * @param {object} contractImplementationInstance - Contract Implementation instance
   */
  addContractImplementation = contractImplementationInstance =&gt; {
    this.contractInstances.push(contractImplementationInstance)
    this.contractEventHandlerMap[
      contractImplementationInstance.getContractAddress()
    ] = {}
  }

  /**
   * Remove contract instance being watched. Will also remove all handlers.
   * @param {string} contractImplementationInstance - contract implementation instance
   */
  removeContractInstance = (
    contractImplementationInstance = isRequired(
      &apos;contractImplementationInstance&apos;
    )
  ) =&gt; {
    const contractAddress = contractImplementationInstance.getContractAddress()
    // remove instance from this.contractInstances
    const removedInstance = _.remove(
      this.contractInstances,
      instance =&gt; instance.getContractAddress() === contractAddress
    )
    // if we didn&apos;t remove anything throw error
    if (removedInstance.length === 0)
      throw new Error(errorConstants.MISSING_CONTRACT_INSTANCE(contractAddress))
    // stop watching on these instances
    removedInstance.forEach(instance =&gt; this.stopWatchingForEvents(instance))

    // remove handlers for contract instance
    delete this.contractEventHandlerMap[contractAddress]
  }

  /**
   * Add event handler that will be called when event log is found.
   * @param {string} contractImplementationInstance - Contract implementation instance
   * @param {string} eventName - Name of event.
   * @param {function} handler - Function to be called when event is consumed.
   */
  addEventHandler = (
    contractImplementationInstance = isRequired(&apos;contractAddress&apos;),
    eventName = isRequired(&apos;eventName&apos;),
    handler = isRequired(&apos;handler&apos;)
  ) =&gt; {
    const contractAddress = contractImplementationInstance.getContractAddress()
    if (!this.contractEventHandlerMap[contractAddress][eventName])
      this.contractEventHandlerMap[contractAddress][eventName] = []
    this.contractEventHandlerMap[contractAddress][eventName].push(handler)
  }

  /**
   * Watch for events on all contract instances. Call registered handlers when logs are found.
   * @param {number} fromBlock - A block number can be passed to catch up on missed logs
   * @returns {Promise} - Promise resolves when all watchers have been started
   */
  watchForEvents = async (fromBlock = &apos;latest&apos;) =&gt;
    Promise.all(
      this.contractInstances.map(async contractImplementation =&gt; {
        const instance = await contractImplementation.loadContract()
        const newWatcherInstance = instance.allEvents({
          fromBlock: fromBlock,
          lastBlock: &apos;latest&apos;
        })

        // NOTE: should we allow more than one listener per contract instance?
        if (this.watcherInstances[instance.address])
          this.watcherInstances[instance.address].stopWatching()

        this.watcherInstances[instance.address] = newWatcherInstance
        newWatcherInstance.watch((error, result) =&gt; {
          if (!error) {
            const handlers = this.contractEventHandlerMap[instance.address][
              result.event
            ]
            if (handlers) {
              handlers.forEach(handler =&gt; {
                this._queueEvent(handler, result)
              })
            }
          }
        })
      })
    )

  /**
   * Stop listening on contract. If no contractAddress supplied it stops all listeners.
   * @param {string} contractImplementationInstance - Address of the contract to stop watching
   */
  stopWatchingForEvents = contractImplementationInstance =&gt; {
    if (contractImplementationInstance) {
      const watcherInstance = this.watcherInstances[
        contractImplementationInstance.getContractAddress()
      ]

      if (watcherInstance) watcherInstance.stopWatching()
    } else
      this.contractInstances.forEach(instance =&gt; {
        this.watcherInstances[instance.getContractAddress()].stopWatching()
      })
  }

  /**
   * Queues an event.
   * @param {function} handler - The handler.
   * @param {object} event - The event.
   */
  _queueEvent = async (handler, event) =&gt; {
    const eventTask = async () =&gt; {
      await handler(event)
    }

    this.eventHandlerQueue.push(eventTask)
  }
}

export default EventListener
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
